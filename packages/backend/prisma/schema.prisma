// Prisma Schema for Seedhunter
// Uses PostgreSQL for production with Bun runtime

generator client {
  provider   = "prisma-client"
  output     = "../src/generated/prisma"
  engineType = "client"
  runtime    = "bun"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Player - Users who play the game via X login
// ============================================
model Player {
  id            String   @id @default(uuid())
  xHandle       String   @unique @map("x_handle")
  xId           String?  @unique @map("x_id")
  xProfilePic   String?  @map("x_profile_pic")
  
  // Current project from The Grid (index in the profileInfos list)
  gridIndex     Int?     @map("grid_index")
  
  // Verification status
  verified      Boolean  @default(false)
  verifiedAt    DateTime? @map("verified_at")
  verifiedBy    String?  @map("verified_by") // Admin who verified
  
  // Optional location (for nearby players feature)
  lastLocationLat Float?  @map("last_location_lat")
  lastLocationLng Float?  @map("last_location_lng")
  lastLocationAt  DateTime? @map("last_location_at")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  tradesAsPlayerA Trade[] @relation("PlayerA")
  tradesAsPlayerB Trade[] @relation("PlayerB")
  chatMessages    ChatMessage[]
  
  @@map("players")
}

// ============================================
// Admin - Staff who verify players and manage
// ============================================
model Admin {
  id            String   @id @default(uuid())
  username      String   @unique
  passwordHash  String   @map("password_hash")
  
  // Location broadcasting
  locationLat       Float?   @map("location_lat")
  locationLng       Float?   @map("location_lng")
  locationVisible   Boolean  @default(true) @map("location_visible")
  locationUpdatedAt DateTime? @map("location_updated_at")
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@map("admins")
}

// Note: Card model removed - now using gridIndex from The Grid API

// ============================================
// Trade - Project swap transactions
// ============================================
model Trade {
  id        String   @id @default(uuid())
  
  // Players involved
  playerAId String   @map("player_a_id")
  playerA   Player   @relation("PlayerA", fields: [playerAId], references: [id])
  
  playerBId String   @map("player_b_id")
  playerB   Player   @relation("PlayerB", fields: [playerBId], references: [id])
  
  // Grid indices swapped (snapshot at trade time)
  gridIndexA Int     @map("grid_index_a")
  gridIndexB Int     @map("grid_index_b")
  
  // Timestamp
  tradedAt  DateTime @default(now()) @map("traded_at")
  
  @@index([playerAId])
  @@index([playerBId])
  @@index([tradedAt])
  @@map("trades")
}

// ============================================
// TradeNonce - Prevent replay attacks
// ============================================
model TradeNonce {
  nonce     String   @id
  expiresAt DateTime @map("expires_at")
  
  // Initiator's location for proximity check
  locationLat Float? @map("location_lat")
  locationLng Float? @map("location_lng")
  
  @@index([expiresAt])
  @@map("trade_nonces")
}

// ============================================
// ChatMessage - Broadcast chat messages
// ============================================
model ChatMessage {
  id          String   @id @default(uuid())
  
  senderId    String   @map("sender_id")
  sender      Player   @relation(fields: [senderId], references: [id])
  
  content     String
  isAdmin     Boolean  @default(false) @map("is_admin")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([createdAt])
  @@map("chat_messages")
}
